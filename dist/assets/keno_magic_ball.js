const{Application:Pt,Graphics:j,Text:h,Container:z}=PIXI,Rt=[[4.5],[2,7.5],[1.5,2.5,16],[1,2,10,50],[.75,1.5,6,30,300],[.5,1.2,4,25,250,3e3]];async function kt(){const tt=document.getElementById("kenoMagicBallCanvas"),ht=4/3;let et=Math.min(window.innerWidth,980),K=et/ht;K>Math.min(window.innerHeight,735)&&(K=Math.min(window.innerHeight,735),et=K*ht);const Ht=()=>({width:et,height:K}),e=new Pt;await e.init({canvas:tt,background:"#333333"});let o,v,gt,W,F,g,t,L=1e3;const nt=new z,ot=new z,i=new z,G=new z;e.stage.addChild(G,nt,i,ot);const u=[],O=[],Y=new h({text:`Balance: ${L}`,style:{fill:16777215,fontSize:28}});Y.anchor.set(1,0),G.addChild(Y);const T=new h({text:"ⓘ INFO",style:{fill:16777215,fontSize:28,fontWeight:"bold",cursor:"pointer"}});T.anchor.set(0,0),T.position.set(20,20),T.eventMode="static",T.cursor="pointer",G.addChild(T);const E=new h({text:`Bet: 1
Win: 
Hits: `,style:{fill:16776960,fontSize:28}});E.anchor.set(0,0),G.addChild(E);const U=new z;G.addChild(U);const R=new z;R.visible=!1,e.stage.addChild(R);const ut=new j().rect(0,0,e.renderer.width,e.renderer.height).fill({color:0,alpha:.8});R.addChild(ut);const D=e.renderer.width*.85,H=e.renderer.height*.75,pt=new j().roundRect((e.renderer.width-D)/2,(e.renderer.height-H)/2,D,H,16).fill({color:2236996});R.addChild(pt);const N=new h({text:`
    MAGIC BALL KENO

    • RTP: 95.76%
    • Pick up to 6 lucky numbers!
    • Hit PLAY to start the draw.
    • Match numbers to win — the more you hit, the bigger the prize!
    • One number is special — the Magic Number.
    • Catch the Magic Number and your total win is boosted ×11!
    • Each play costs 1 credit.
    • Winnings appear on the right.
    
    Good luck and may the Magic be with you!

  `,style:{fill:16777215,fontSize:24,wordWrap:!0,wordWrapWidth:D*.9,lineHeight:36}});N.anchor.set(.5,0),N.position.set(e.renderer.width/2,(e.renderer.height-H)/2+50),R.addChild(N);const M=new h({text:"✖ CLOSE",style:{fill:16729156,fontSize:28,fontWeight:"bold",cursor:"pointer"}});M.anchor.set(.5),M.position.set(e.renderer.width/2,(e.renderer.height+H)/2-40),M.eventMode="static",M.cursor="pointer",R.addChild(M),T.on("pointerdown",()=>{R.visible=!0}),M.on("pointerdown",()=>{R.visible=!1});function it(){Y.text=`Balance: ${L}`,Y.position.set(o-20,20)}function Mt(){const c=(o+F)/2,C=W;E.position.set(c,C)}function Z(){U.removeChildren();const c=u.length;if(c===0||c>Rt.length)return;const C=Rt[c-1],B={fill:16777215,fontSize:g*.04},w=g*.06;C.forEach((_,A)=>{const P=`Hit ${(A+1).toString()}`,m=new h({text:`${P}: ${_.toFixed(2)}x`,style:B});m.anchor.set(0,1),m.position.set(0,-A*w),U.addChild(m)});const x=(o+F)/2-t/4,y=W+g*.9;U.position.set(x,y)}function Bt(c,C){return new Promise(B=>{if(!c?.length){B();return}const w=c.length,x=.15,y=3,_=c.findIndex(b=>b.num===C),A=y*w+_+1;let P=0;const m=gsap.timeline();for(let b=0;b<A;b++)m.call(()=>{c.forEach(({bg:$,baseColor:s})=>{$.clear().roundRect(0,0,$.size,$.size,8).fill({color:s})});const I=c[P];I&&gsap.to({},{duration:.1,onStart:()=>{I.bg.stroke({color:11365568,width:6})}}),P=(P+1)%w},null,"+="+x);m.call(()=>{const b=c.find(I=>I.num===C);b?gsap.to(b.bg,{duration:.6,repeat:1,yoyo:!0,onUpdate:()=>{b.bg.stroke({color:11365568,width:8})},onComplete:B}):B()})})}function wt(){const{width:c,height:C}=Ht(),B=4/3;o=c,v=c/B,v>C&&(v=C,o=v*B),e.renderer.resize(o,v),tt.style.display="block",tt.style.margin="0 auto",nt.removeChildren(),ot.removeChildren(),i.removeChildren();const w=6,x=6,y=8;F=o*.6,g=v*.6;const _=(F-(x-1)*y)/x,A=(g-(w-1)*y)/w;t=Math.min(_,A);const P=x*t+(x-1)*y,m=w*t+(w-1)*y;gt=(o-P)/2,W=(v-m)/2,O.length=0;for(let l=0;l<w;l++)for(let n=0;n<x;n++){const d=l*x+n+1,r=new z;r.x=gt+n*(t+y),r.y=W+l*(t+y),r.eventMode="static",r.cursor="pointer";const p=new j().roundRect(0,0,t,t,10).fill({color:5592405});r.addChild(p);const S=new h({text:d.toString(),style:{fill:16777215,fontSize:t*.4}});S.anchor.set(.5),S.position.set(t/2,t/2),r.addChild(S),r.on("pointerdown",()=>{const a=u.indexOf(d);if(a===-1){if(u.length>=6)return;u.push(d),p.clear().roundRect(0,0,t,t,10).fill({color:16729156}),Z()}else u.splice(a,1),p.clear().roundRect(0,0,t,t,10).fill({color:5592405}),Z()}),nt.addChild(r),O.push({number:d,bg:p})}u.forEach(l=>{const n=O.find(d=>d.number===l);n&&(n.bg.clear(),n.bg.roundRect(0,0,t,t,10).fill({color:16729156}))}),N.style.fontSize=g*.05,N.style.lineHeight=g*.05*1.2,M.style.fontSize=g*.05,T.style.fontSize=g*.05,Y.style.fontSize=g*.05,Y.position.set(o-20,20),E.style.fontSize=g*.05;const b=(o+F)/2+t/4,I=W;E.position.set(b,I),i.removeChildren();const $=6,s=t*.7,xt=6,Tt=xt*s+(xt-1)*$,yt=20,bt=15,Ct=Tt+yt*2,rt=s+bt*2,mt=(o-Ct)/2,q=.65*W-rt/2,lt=new j().roundRect(0,0,Ct,rt,12).fill({color:2236996});lt.alpha=.7,lt.position.set(mt,q),i.addChild(lt);const ct=new h({text:"",style:{fill:16777215,fontSize:s*.5}});ct.anchor.set(.5),ct.position.set(o/2,q-s*.4),i.addChild(ct);const Q=new h({text:"Waiting for draw...",style:{fill:11184810,fontSize:s*.5,fontStyle:"italic"}});Q.anchor.set(.5),Q.position.set(o/2,q+rt/2),Q.label="placeholder",i.addChild(Q);const V=o*.25,st=v*.08,St=W+m+t,zt=o*.1;function vt(l,n,d){const r=new z,p=new j().roundRect(-V/2,-st/2,V,st,12).fill({color:n});r.addChild(p);const S=new h({text:l,style:{fill:16777215,fontSize:st*.5}});return S.anchor.set(.5),r.addChild(S),r.eventMode="static",r.cursor="pointer",r.on("pointerdown",async()=>{p.tint=21964,await d(),p.tint=16777215,p.tint=n}),r}const k=vt("PLAY",30719,async()=>{if(!(L<=0)){if(u.length===0){i.children.length>2&&i.removeChildren(2,i.children.length);const l=new h({text:"Select at least one number!",style:{fill:16733525,fontSize:24}});l.anchor.set(.5),l.position.set(o/2,.5*W),i.addChild(l);return}k.eventMode="none",k.alpha=.5,L-=1,it();try{const n=await(await fetch("/api/keno_magic_ball/play",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({selected:u,balance:L})})).json();O.forEach(({number:a,bg:f})=>{f.clear(),f.roundRect(0,0,t,t,10).fill({color:5592405}),u.includes(a)&&(f.clear(),f.roundRect(0,0,t,t,10).fill({color:16729156})),n.winningNumbers.includes(a)&&f.stroke({color:65280,width:6})});const d=i.children.find(a=>a.label==="placeholder");d&&(d.visible=!1),i.children.length>2&&i.removeChildren(2,i.children.length);const r=mt+yt,p=q+bt,S=[];n.drawnNumbers.forEach((a,f)=>{const Et=r+f*(s+$),Nt=p,J=new z;J.x=Et,J.y=Nt;const Wt=n.winningNumbers.includes(a),dt=Wt?65280:16763904,X=new j().roundRect(0,0,s,s,8).fill({color:dt});a===n.magicNumber&&X.stroke({color:11365568,width:6}),X.isWinning=Wt,X.size=s,X.baseColor=dt,J.addChild(X);const ft=new h({text:a.toString(),style:{fill:0,fontSize:s*.4}});ft.anchor.set(.5),ft.position.set(s/2,s/2),J.addChild(ft),i.addChild(J),S.push({num:a,bg:X,baseColor:dt})}),await Bt(S,n.magicNumber),E.text=`Bet: 1
Win: ${n.win}
Hits: ${n.hits}

Magic Number: ${n.magicNumber}`,L=n.balance.toFixed(2),it(),setTimeout(()=>{i.children.length>2&&i.removeChildren(2,i.children.length),O.forEach(({number:a,bg:f})=>{f.clear(),f.roundRect(0,0,t,t,10).fill({color:5592405}),u.includes(a)&&(f.clear(),f.roundRect(0,0,t,t,10).fill({color:16729156}))}),k.eventMode="static",k.alpha=1,E.text=`Bet: 1
Win: 
Hits:  `,d&&(d.visible=!0)},2500)}catch{}}}),at=vt("CLEAR",16729156,async()=>{u.length=0,O.forEach(({bg:l})=>l.clear().roundRect(0,0,t,t,10).fill({color:5592405})),Z()});ut.clear().rect(0,0,e.renderer.width,e.renderer.height).fill({color:0,alpha:.8}),pt.clear().roundRect((e.renderer.width-D)/2,(e.renderer.height-H)/2,D,H,16).fill({color:2236996}),N.style.wordWrapWidth=e.renderer.width*.7,N.position.set(e.renderer.width/2,(e.renderer.height-H)/2+50),M.position.set(e.renderer.width/2,(e.renderer.height+H)/2-40),k.x=o/2-V/2-zt/2,k.y=St,at.x=o/2+V/2+zt/2,at.y=St,ot.addChild(k,at),it(),Mt(),Z()}wt(),window.addEventListener("resize",wt)}kt();
