const{Application:Ct,Graphics:x,Text:U,Container:lt,Sprite:rt,Assets:Mt,BlurFilter:_t}=PIXI,f={spinDuration:150,reelDelay:100,startSpeed:35,decelFactor:.75,minSpeed:10,bounceAmplitude:150,bounceDuration:500,bounceEase:r=>1-(1-r)**2,enableBlur:!0,maxBlur:6,easeOut:r=>1-(1-r)**3};function F(r){if(r>=1e3)return`item_${r%1e3}`;if(r===1)return"basic_8";if(r===2)return"basic_9";if(r===3)return"basic_10";if(r===4)return"basic_j";if(r===5)return"basic_q";if(r===6)return"basic_k";if(r===7)return"basic_a";if(r===8)return"basic_star"}const at=[[0,0,0,0,0],[1,1,1,1,1],[2,2,2,2,2],[0,1,2,1,0],[2,1,0,1,2]];class kt{constructor(a,n,l,s,c,d,p){this.app=a,this.textures=n,this.x=l,this.y=s,this.visibleCount=c,this.cellSize=d,this.symbols=Array.from({length:20},()=>Math.floor(Math.random()*8)+1),this.offset=0,this.container=new lt,this.container.mask=p,a.stage.addChild(this.container),this.sprites=Array.from({length:c},(b,m)=>{const y=new rt(this.textures[F(this.symbols[m])]);return y.width=d-10,y.height=d-10,y.x=this.x+5,y.y=this.y+m*d+5,this.container.addChild(y),y}),this.isSpinning=!1,this.speed=0,this.state="idle",this.stopSymbols=[],this.onStopComplete=null,this.filter=new _t,this.filter&&(this.filter.strength=0,this.sprites.forEach(b=>b.filters=[this.filter])),this.shine=new x().rect(this.x+2,this.y,d-4,this.visibleCount*d).fill({color:16777215,alpha:0}),this.container.addChild(this.shine)}randomSymbol(){return Math.floor(Math.random()*7)+1}startSpin(){this.isSpinning=!0,this.state="spinning",this.speed=f.startSpeed,this.stopSymbols=[],this.filter&&(this.filter.strength=f.maxBlur)}stopAt(a){this.stopSymbols=a.slice(),this.state="stopping"}update(a){if(this.isSpinning){for(this.state==="stopping"&&this.speed>f.minSpeed&&(this.speed-=f.decelFactor),this.offset+=this.speed*(a/16.6);this.offset>=this.cellSize;)this.offset-=this.cellSize,this.symbols.pop(),this.symbols.unshift(this.randomSymbol());if(this.filter&&f.enableBlur){const n=Math.min(this.speed/f.startSpeed,1);this.filter.strength=f.maxBlur*n}for(let n=0;n<this.visibleCount;n++){const l=(n+Math.floor(this.offset/this.cellSize))%this.symbols.length,s=this.symbols[l],c=this.sprites[n];c.texture=this.textures[F(s)],c.y=this.y+n*this.cellSize+5+this.offset%this.cellSize}this.state==="stopping"&&this.speed<=f.minSpeed&&this.alignToStop()}}alignToStop(){this.speed=0,this.isSpinning=!1,this.state="idle";for(let a=0;a<this.visibleCount;a++){const n=this.stopSymbols[a]!==void 0?this.stopSymbols[a]:this.randomSymbol(),l=this.sprites[a];l.texture=this.textures[F(n)],l.y=this.y+a*this.cellSize+5}this._bounceDone=!1,this._shineDone=!1,this.filter&&(this.filter.strength=f.maxBlur*.3),this.startBounce(),this.shineSweep()}startBounce(){const a=f.bounceAmplitude,n=f.bounceDuration,l=f.bounceEase,s=performance.now(),c=()=>{const d=Math.min((performance.now()-s)/n,1),p=l(d),b=Math.sin(p*Math.PI)*a*(1-p);for(let m=0;m<this.visibleCount;m++){const y=this.sprites[m];y.y=this.y+m*this.cellSize+5+b}this.filter&&f.enableBlur&&(this.filter.strength=f.maxBlur*.3*(1-p)),d>=1&&(this.filter&&(this.filter.strength=0),this.app.ticker.remove(c),this._bounceDone=!0,this._shineDone&&this.onStopComplete&&this.onStopComplete(this))};this.app.ticker.add(c)}shineSweep(){const a=this.visibleCount*this.cellSize,n=300,l=performance.now(),s=()=>{const c=Math.min((performance.now()-l)/n,1),d=this.y+c*a,p=c<.5?.6:.6*(1-(c-.5)*2);this.shine.clear(),this.shine.rect(this.x+2,d,this.cellSize-4,this.cellSize/2),this.shine.fill({color:16777215,alpha:p}),c>=1&&(this.shine.clear(),this.app.ticker.remove(s),this._shineDone=!0,this._bounceDone&&this.onStopComplete&&this.onStopComplete(this))};this.app.ticker.add(s)}}async function Bt(){const r=document.getElementById("slotFortuneForgeJourneyCanvas"),a=4/3;let n=Math.min(window.innerWidth,980),l=n/a;l>Math.min(window.innerHeight,735)&&(l=Math.min(window.innerHeight,735),n=l*a);const s=new Ct;await s.init({canvas:r,background:"#333333",width:n,height:l});const c=n*.1,d=l*.2,p=n*.8,b=l*.6,m=d,y=new x().roundRect(c,m,p,b,16).fill({color:2236962}).stroke({width:3,color:16777215});s.stage.addChild(y);const L=5,G=3,o=Math.min(p/L,b/G),H=L*o,V=G*o,_=c+(p-H)/2,k=m+(b-V)/2,Z=10,w=o/2,q=Z*w,X=_+(H-q)/2,$=k-w*1.2,tt=new x().roundRect(X-8,$-8,q+16,w+16,8).fill({color:4473924}).stroke({width:2,color:16777215});s.stage.addChild(tt);for(let t=0;t<Z;t++){const i=new x().roundRect(X+t*w,$,w-4,w-4,6).fill({color:2236962}).stroke({width:2,color:8947848});s.stage.addChild(i)}const B=Array(10).fill(null);function ct(t,i){if(t<0||t>=10)return;B[t]&&s.stage.removeChild(B[t]);const e=new rt(i);e.width=w-8,e.height=w-8,e.x=X+t*w+4,e.y=$+4,s.stage.addChild(e),B[t]=e}const et=new x().rect(_,k,H,V).fill({color:16777215});s.stage.addChild(et);const ht=["basic_8","basic_9","basic_10","basic_j","basic_q","basic_k","basic_a","basic_star","item_1","item_2","item_3","item_4","item_5","item_6","item_7","item_8","item_9","item_10"],J={};for(const t of ht)J[t]=await Mt.load(`/assets/slot_fortune_forge_journey/${t}.png`);const P=[];for(let t=0;t<L;t++){const i=_+t*o,e=new kt(s,J,i,k,G,o,et);P.push(e)}s.ticker.add(t=>P.forEach(i=>i.update(t.deltaMS)));const T=new lt;s.stage.addChild(T);function ft(){T.children.forEach(t=>{gsap.killTweensOf(t.scale)}),T.removeChildren()}function dt(){B.forEach((t,i)=>{t&&gsap.fromTo(t,{alpha:1},{alpha:.2,duration:1,ease:"power2.inOut",yoyo:!0,repeat:3})}),gsap.delayedCall(1.5,()=>{pt()}),gsap.delayedCall(5.7,()=>{gsap.fromTo(tt,{alpha:1},{alpha:.3,duration:.2,yoyo:!0,repeat:1}),mt()})}function pt(){const t=Math.floor(Math.random()*6)+10;for(let i=0;i<t;i++){const e=i*.1+Math.random()*.15;gsap.delayedCall(e,()=>{ut()})}}function ut(){const t=X+Math.random()*q,i=$+Math.random()*w,e=Math.floor(Math.random()*200)+250,D=[16774502,16768324,16763955,16759586,16755200],W=D[Math.floor(Math.random()*D.length)];for(let E=0;E<e;E++){const C=new x().circle(0,0,Math.random()*3+1).fill({color:W,alpha:1});C.x=t,C.y=i,s.stage.addChild(C);const z=Math.random()*Math.PI*2,I=150+Math.random()*80,O=Math.cos(z)*I,u=Math.sin(z)*I;gsap.to(C,{x:t+O,y:i+u,alpha:0,duration:2.5+Math.random()*.4,ease:"power2.out",onComplete:()=>{s.stage.removeChild(C)}})}}function mt(){for(let t=0;t<B.length;t++){const i=B[t];i&&(gsap.killTweensOf(i),s.stage.removeChild(i),B[t]=null)}}function gt(t){const i=at[t];if(!i)return;const e=new x,D=16711680,W=Math.max(4,o*.08),E=_+o/2,C=k+i[0]*o+o/2;e.moveTo(E,C);for(let u=1;u<L;u++){const N=_+u*o+o/2,j=k+i[u]*o+o/2;e.lineTo(N,j)}e.stroke({width:W,color:D,alpha:.9,cap:"round",join:"round"}),e.alpha=0,T.addChild(e);const z=250,I=performance.now(),O=()=>{const u=Math.min((performance.now()-I)/z,1);e.alpha=u,u<1&&s.ticker.addOnce(O)};return s.ticker.addOnce(O),e}function yt(t,i){const e=new x().circle(0,0,o*.45).fill({color:16777113,alpha:.35});e.x=_+t*o+o/2,e.y=k+i*o+o/2,T.addChild(e),gsap.fromTo(e.scale,{x:1,y:1},{x:1.2,y:1.2,duration:.6,yoyo:!0,repeat:-1,ease:"sine.inOut"})}function wt(t,i){const e=new x().circle(0,0,o*.5).fill({color:16772710,alpha:.6});e.x=_+t*o+o/2,e.y=k+i*o+o/2,T.addChild(e),gsap.fromTo(e,{alpha:0,scale:.3},{alpha:1,scale:1.2,duration:.6,yoyo:!0,repeat:2,ease:"sine.inOut",onComplete:()=>{gsap.to(e,{alpha:0,duration:.3,onComplete:()=>{T.removeChild(e)}})}})}let g=1e3;const v=new U({text:`Balance: ${g}`,style:{fill:"#ffffff",fontSize:Math.min(l*.03,20),fontWeight:"bold"}});v.x=n-180,v.y=10,v.text=`Balance: ${g}`,s.stage.addChild(v);const M=new U({text:"",style:{fill:"#ffffff",fontSize:Math.min(l*.03,20),fontWeight:"bold"}});M.x=n/2,M.y=10,M.alpha=0,s.stage.addChild(M);const it=p*.4,st=50,xt=n/2-it/2,nt=m+b+l*.05,h=new x().roundRect(xt,nt,it,st,10).fill({color:43520}).stroke({width:3,color:16777215});s.stage.addChild(h);const S=new U({text:"SPIN",style:{fill:"#ffffff",fontSize:24,fontWeight:"bold"}});S.anchor.set(.5),S.x=n/2,S.y=nt+st/2,s.stage.addChild(S);function K(){h.eventMode="none",h.tint=5592405,S.text="NO BALANCE"}function ot(){h.eventMode="static",h.tint=43520,S.text="SPIN"}h.eventMode="static",h.cursor="pointer",h.on("pointerdown",async()=>{if(g<1){K();return}h.eventMode="none",h.tint=34816,S.text="SPINNING...";const t=g-1;v.text=`Balance: ${t}`,ft(),M.text="",M.alpha=0;try{const e=await(await fetch("/api/slot_fortune_forge_journey/spin",{method:"POST",headers:{"Content-Type":"application/json"}})).json();if(e.error){g=e.balance,v.text=`Balance: ${g}`,g<1?K():ot();return}P.forEach(N=>N.startSpin());const{reels:D,collected:W,win:E,winningLines:C,collectedWin:z,balance:I,newCollected:O,scatters:u}=e;P.forEach((N,j)=>{setTimeout(()=>{N.onStopComplete=Tt=>{j===P.length-1&&(g=I,v.text=`Balance: ${g}`,E>0&&(M.text=`Win: ${E}`,M.alpha=1),W.forEach((A,R)=>{ct(A%1e3-1,J[F(A)])}),W.length===10&&dt(),C.forEach(({lineIndex:A,length:R})=>{gt(A);const bt=at[A];for(let Y=0;Y<R;Y++){const St=bt[Y];yt(Y,St)}}),Array.isArray(u)&&u.forEach(({col:A,row:R})=>{wt(A,R)}),g<1?K():ot(),S.text="SPIN",h.tint=16777215,h.eventMode="static")},N.stopAt(D[j])},j*f.reelDelay+f.spinDuration+1)})}catch(i){console.error("Spin request failed:",i),S.text="SPIN",h.tint=16777215,h.eventMode="static"}});let Q=!1;window.addEventListener("keydown",t=>{t.code==="Space"&&!Q&&(Q=!0,t.preventDefault(),h.eventMode==="static"&&g>=1&&h.emit("pointerdown"))}),window.addEventListener("keyup",t=>{t.code==="Space"&&(Q=!1)})}Bt();
