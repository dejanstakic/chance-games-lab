const{Application:lt,Graphics:P,Text:S,Container:x}=PIXI,rt=100;async function dt(){const _=document.getElementById("hold81Canvas"),J=4/3;let T=Math.min(window.innerWidth,980),w=T/J;w>Math.min(window.innerHeight,735)&&(w=Math.min(window.innerHeight,735),T=w*J);const I=new lt;await I.init({canvas:_,background:"#333333",width:T,height:w});const q=T*.06,F=w*.06,U=T*.8,tt=w*.8,A=new x;A.x=q,A.y=F,I.stage.addChild(A);const H=Math.min(U,tt),c=H/3,d=c/3,g=[],B=new Set([0]);for(let t=0;t<9;t++){const n=new x,e=new x,o=new x,i=new x;n.addChild(e),n.addChild(o),n.addChild(i);const l=t%3,u=2-Math.floor(t/3);n.x=l*c,n.y=u*c;const f=new P;f.rect(0,0,c,c),f.fill(1118481),e.addChild(f);const L=[];for(let b=0;b<9;b++){const m=b%3,Z=Math.floor(b/3),h=m*d,k=Z*d,$=new P;$.rect(h,k,d,d),$.stroke({width:1,color:11184810}),o.addChild($);const C=new S({text:"",style:{fontSize:d*.5,fill:16768358,fontWeight:"bold",stroke:0,strokeThickness:Math.max(2,d*.08)}});C.anchor.set(.5),C.x=h+d/2,C.y=k+d/2,C.visible=!1,o.addChild(C),L.push({bg:$,valueText:C,x:h,y:k,spinner:null,reel:null})}const W=new P;i.addChild(W),A.addChild(n),g.push({gridId:t,container:n,bgLayer:e,cellLayer:o,overlayLayer:i,bgGraphics:f,borderGraphics:W,cells:L})}Y(0);const v=new x;v.x=q+H+100,v.y=F,I.stage.addChild(v);let M=1e3;const p=new S({text:`Balance: ${M}`,style:{fill:16777215,fontSize:18,fontWeight:"bold",align:"right"}});p.style.align="right",p.x=180,p.y=0,p.anchor.set(1,0),v.addChild(p);const R={fill:16777215,fontSize:22,fontWeight:"bold"},D=new S({text:"Spins left: 3",style:R}),E=new S({text:"Step win: ",style:R}),X=new S({text:"Total win: ",style:{...R,fontWeight:"bold"}});D.y=80,E.y=120,X.y=160,v.addChild(D,E,X);let j=0;function N(t){D.text=`Spins left: ${t}`}function O(t){E.text=`Step win: ${t}`}function V(t){X.text=`Total win: ${t}`}async function nt(t){j=0,V(0);for(const n of t)await et(n);await K(1500),at(),O(""),N(""),V("")}async function et(t){N(t.respinsAfter),O("");const n=[];let e=0;const o=t.spinResults.length;o<10&&(e=1e3),o<15&&(e=750);for(const i of t.spinResults){const l=g[i.gridId],a=l.cells[i.cellId];e+=60+Math.random()*60,n.push(ot(a,l.cellLayer,i.value,e))}await Promise.all(n),O(t.win),j+=t.win,V(j),N(t.respinsAfter);for(const i of t.newGridsUnlocked||[])B.has(i)||(B.add(i),Y(i));await K(1e3)}function ot(t,n,e,o){return new Promise(i=>{const l=450+Math.random()*250,a=o+Math.random()*250;setTimeout(()=>{it(t,n,a,()=>{st(t,e),i()})},l)})}function K(t){return new Promise(n=>setTimeout(n,t))}function it(t,n,e,o){const i=t.x+d/2,l=t.y+d/2,a=new P;t.spinner=a,n.addChild(a);const u=d*.32,f=2+Math.random()*2,L=performance.now();function W(b){const m=Math.min((b-L)/e,1),h=(1-Math.pow(1-m,3))*Math.PI*2*f,k=Math.PI*(.7-.5*m);a.clear(),a.moveTo(i,l).lineTo(i+Math.cos(h)*u,l+Math.sin(h)*u).arc(i,l,u,h,h+k).lineTo(i,l).fill({color:16106818,alpha:.8*(1-m)}),m<1?requestAnimationFrame(W):(a.destroy(),t.spinner=null,o())}requestAnimationFrame(W)}function st(t,n){if(n>0){let a=function(u){const f=Math.min((u-i)/l,1);o.alpha=f,o.scale.set(.3+.7*f),f<1&&requestAnimationFrame(a)};var e=a;const o=t.valueText;o.text=n.toString(),o.visible=!0,o.alpha=0,o.scale.set(.3);const i=performance.now(),l=220;requestAnimationFrame(a)}}function at(){B.clear(),B.add(0);for(let t=0;t<g.length;t++){t===0?Y(0):ct(t);for(const n of g[t].cells)n.valueText.visible=!1,n.valueText.text="",n.spinner?.destroy(),n.spinner=null}}function Y(t){const n=g[t];n.bgGraphics.clear(),n.bgGraphics.rect(0,0,c,c),n.bgGraphics.fill(2776023),n.borderGraphics.clear();const e=4,o=e/2;n.borderGraphics.rect(o,o,c-e,c-e).stroke({width:e,color:16777062})}function ct(t){const n=g[t];n.bgGraphics.clear(),n.bgGraphics.rect(0,0,c,c),n.bgGraphics.fill(1118481),n.borderGraphics.clear();const e=2,o=e/2;n.borderGraphics.rect(o,o,c-e,c-e).stroke({width:e,color:7829367})}const s=new x,r=new P,G=160,z=50;r.rect(0,0,G,z),r.fill(26316),r.stroke({width:2,color:16777215}),s.addChild(r);const y=new S({text:"SPIN",style:{fill:16777215,fontSize:22,fontWeight:"bold"}});y.anchor.set(.5),y.x=G/2,y.y=z/2,s.addChild(y),s.x=(U-q)/2-G/2,s.y=F+H+30,s.eventMode="static",s.cursor="pointer",I.stage.addChild(s);function Q(t){t?(s.eventMode="static",s.cursor="pointer",r.clear(),r.rect(0,0,G,z),r.fill(26316),r.stroke({width:2,color:16777215}),y.alpha=1,s.alpha=1):(s.eventMode="none",s.cursor="default",r.clear(),r.rect(0,0,G,z),r.fill(4473924),r.stroke({width:2,color:8947848}),y.alpha=.6,s.alpha=.8)}s.on("pointerdown",async()=>{Q(!1);try{const n=await(await fetch("/api/hold81/spin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({balance:M})})).json(),e=M-rt;p.text=`Balance: ${e}`,await nt(n.steps),M=n.balance,p.text=`Balance ${M}`}catch(t){console.error(t)}Q(!0)})}dt();
