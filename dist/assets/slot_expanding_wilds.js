const{Application:ct,Graphics:C,Text:H,Container:it,Sprite:dt,Assets:pt,BlurFilter:et}=PIXI,f={spinDuration:150,reelDelay:100,startSpeed:35,decelFactor:.75,minSpeed:10,bounceAmplitude:150,bounceDuration:500,bounceEase:a=>1-(1-a)**2,enableBlur:!0,maxBlur:6,easeOut:a=>1-(1-a)**3};function P(a){if(a===1)return"symbol_1";if(a===2)return"symbol_2";if(a===3)return"symbol_3";if(a===4)return"symbol_4";if(a===5)return"symbol_5";if(a===6)return"symbol_6";if(a===7)return"symbol_7";if(a===8)return"symbol_8";if(a===9)return"symbol_9"}const st=[[0,0,0,0,0],[1,1,1,1,1],[2,2,2,2,2],[0,1,2,1,0],[2,1,0,1,2],[0,1,0,1,0],[1,2,1,2,1],[1,0,1,0,1],[2,1,2,1,2]];class ut{constructor(i,t,e,n,r,d,p){this.app=i,this.textures=t,this.x=e,this.y=n,this.visibleCount=r,this.cellSize=d,this.symbols=Array.from({length:20},()=>Math.floor(Math.random()*7)+2),this.offset=0,this.container=new it,this.container.mask=p,i.stage.addChild(this.container),this.sprites=Array.from({length:r},(w,y)=>{const x=new dt(this.textures[P(this.symbols[y])]);return x.width=d-10,x.height=d-10,x.x=this.x+5,x.y=this.y+y*d+5,this.container.addChild(x),x}),this.isSpinning=!1,this.speed=0,this.state="idle",this.stopSymbols=[],this.onStopComplete=null,this.filter=new et,this.filter&&(this.filter.strength=0,this.sprites.forEach(w=>w.filters=[this.filter])),this.shine=new C().rect(this.x+2,this.y,d-4,this.visibleCount*d).fill({color:16777215,alpha:0}),this.container.addChild(this.shine)}randomSymbol(){return Math.floor(Math.random()*7)+2}startSpin(){this.isSpinning=!0,this.state="spinning",this.speed=f.startSpeed,this.stopSymbols=[],this.filter&&(this.filter.strength=f.maxBlur)}stopAt(i){this.stopSymbols=i.slice(),this.state="stopping"}update(i){if(this.isSpinning){for(this.state==="stopping"&&this.speed>f.minSpeed&&(this.speed-=f.decelFactor),this.offset+=this.speed*(i/16.6);this.offset>=this.cellSize;)this.offset-=this.cellSize,this.symbols.pop(),this.symbols.unshift(this.randomSymbol());if(this.filter&&f.enableBlur){const t=Math.min(this.speed/f.startSpeed,1);this.filter.strength=f.maxBlur*t}for(let t=0;t<this.visibleCount;t++){const e=(t+Math.floor(this.offset/this.cellSize))%this.symbols.length,n=this.symbols[e],r=this.sprites[t];r.texture=this.textures[P(n)],r.y=this.y+t*this.cellSize+5+this.offset%this.cellSize}this.state==="stopping"&&this.speed<=f.minSpeed&&this.alignToStop()}}alignToStop(){this.speed=0,this.isSpinning=!1,this.state="idle";for(let i=0;i<this.visibleCount;i++){const t=this.stopSymbols[i]!==void 0?this.stopSymbols[i]:this.randomSymbol(),e=this.sprites[i];e.texture=this.textures[P(t)],e.y=this.y+i*this.cellSize+5}this._bounceDone=!1,this._shineDone=!1,this.filter&&(this.filter.strength=f.maxBlur*.3),this.startBounce(),this.shineSweep()}startBounce(){const i=f.bounceAmplitude,t=f.bounceDuration,e=f.bounceEase,n=performance.now(),r=()=>{const d=Math.min((performance.now()-n)/t,1),p=e(d),w=Math.sin(p*Math.PI)*i*(1-p);for(let y=0;y<this.visibleCount;y++){const x=this.sprites[y];x.y=this.y+y*this.cellSize+5+w}this.filter&&f.enableBlur&&(this.filter.strength=f.maxBlur*.3*(1-p)),d>=1&&(this.filter&&(this.filter.strength=0),this.app.ticker.remove(r),this._bounceDone=!0,this._shineDone&&this.onStopComplete&&this.onStopComplete(this))};this.app.ticker.add(r)}shineSweep(){const i=this.visibleCount*this.cellSize,t=300,e=performance.now(),n=()=>{const r=Math.min((performance.now()-e)/t,1),d=this.y+r*i,p=r<.5?.6:.6*(1-(r-.5)*2);this.shine.clear(),this.shine.rect(this.x+2,d,this.cellSize-4,this.cellSize/2),this.shine.fill({color:16777215,alpha:p}),r>=1&&(this.shine.clear(),this.app.ticker.remove(n),this._shineDone=!0,this._bounceDone&&this.onStopComplete&&this.onStopComplete(this))};this.app.ticker.add(n)}setInstant(i){for(let t=0;t<this.visibleCount;t++){const e=i[t]??this.randomSymbol(),n=this.sprites[t];n.texture=this.textures[P(e)],n.y=this.y+t*this.cellSize+5}}playExpandWild(i){return new Promise(t=>{const e=new C().roundRect(this.x+4,this.y+4,this.cellSize-8,this.visibleCount*this.cellSize-8,10).fill({color:16737792,alpha:0});this.filter&&(e.filters=[new et(4)]),this.container.addChild(e),gsap.to(e,{alpha:.75,duration:.18,yoyo:!0,repeat:1,ease:"sine.inOut",onRepeat:()=>{this.setInstant(i)},onComplete:()=>{this.container.removeChild(e),e.destroy(),t()}})})}}async function mt(){const a=document.getElementById("slotExpandingWildsCanvas"),i=4/3;let t=Math.min(window.innerWidth,980),e=t/i;e>Math.min(window.innerHeight,735)&&(e=Math.min(window.innerHeight,735),t=e*i);const n=new ct;await n.init({canvas:a,background:"#333333",width:t,height:e});const r=t*.1,d=e*.15,p=t*.8,w=e*.6,y=d,x=new C().roundRect(r,y,p,w,16).fill({color:2236962}).stroke({width:3,color:16777215});n.stage.addChild(x);const z=5,L=3,l=Math.min(p/z,w/L),F=z*l,q=L*l,T=r+(p-F)/2,B=y+(w-q)/2,J=new C().rect(T,B,F,q).fill({color:16777215});n.stage.addChild(J);const nt=["symbol_1","symbol_2","symbol_3","symbol_4","symbol_5","symbol_6","symbol_7","symbol_8","symbol_9"],K={};for(const o of nt)K[o]=await pt.load(`/assets/slot_expanding_wilds/${o}.png`);const k=[];for(let o=0;o<z;o++){const c=T+o*l,s=new ut(n,K,c,B,L,l,J);k.push(s)}n.ticker.add(o=>k.forEach(c=>c.update(o.deltaMS)));const _=new it;n.stage.addChild(_);function ot(){_.children.forEach(o=>{gsap.killTweensOf(o.scale)}),_.removeChildren()}const Q=[16726843,3931963,3894527,16767291,16727029,3932149,16747579,9190399,3932044];function lt(o){const c=st[o];if(!c)return;const s=new C,E=Q[o%Q.length],N=Math.max(4,l*.08),j=T+l/2,G=B+c[0]*l+l/2;s.moveTo(j,G);for(let m=1;m<z;m++){const D=T+m*l+l/2,A=B+c[m]*l+l/2;s.lineTo(D,A)}s.stroke({width:N,color:E,alpha:.9,cap:"round",join:"round"}),s.alpha=0,_.addChild(s);const O=250,X=performance.now(),I=()=>{const m=Math.min((performance.now()-X)/O,1);s.alpha=m,m<1&&n.ticker.addOnce(I)};return n.ticker.addOnce(I),s}function at(o,c){const s=new C().circle(0,0,l*.45).fill({color:16777113,alpha:.35});s.x=T+o*l+l/2,s.y=B+c*l+l/2,_.addChild(s),gsap.fromTo(s.scale,{x:1,y:1},{x:1.2,y:1.2,duration:.6,yoyo:!0,repeat:-1,ease:"sine.inOut"})}function rt(o,c){const s=new C().circle(0,0,l*.5).fill({color:16772710,alpha:.6});s.x=T+o*l+l/2,s.y=B+c*l+l/2,_.addChild(s),gsap.fromTo(s,{alpha:0,scale:.3},{alpha:1,scale:1.2,duration:.6,yoyo:!0,repeat:2,ease:"sine.inOut",onComplete:()=>{gsap.to(s,{alpha:0,duration:.3,onComplete:()=>{_.removeChild(s)}})}})}let u=1e3;const M=new H({text:`Balance: ${u}`,style:{fill:"#ffffff",fontSize:Math.min(e*.03,20),fontWeight:"bold"}});M.x=t-180,M.y=10,M.text=`Balance: ${u}`,n.stage.addChild(M);const g=new H({text:"",style:{fill:"#ffffff",fontSize:Math.min(e*.03,20),fontWeight:"bold"}});g.x=t/2,g.y=10,g.alpha=0,n.stage.addChild(g);const U=p*.4,V=50,ht=t/2-U/2,Z=y+w+e*.05,h=new C().roundRect(ht,Z,U,V,10).fill({color:43520}).stroke({width:3,color:16777215});n.stage.addChild(h);const S=new H({text:"SPIN",style:{fill:"#ffffff",fontSize:24,fontWeight:"bold"}});S.anchor.set(.5),S.x=t/2,S.y=Z+V/2,n.stage.addChild(S);function R(){h.eventMode="none",h.tint=5592405,S.text="NO BALANCE"}function tt(){h.eventMode="static",h.tint=43520,S.text="SPIN"}h.eventMode="static",h.cursor="pointer",h.on("pointerdown",async()=>{if(u<1){R();return}h.eventMode="none",h.tint=34816,S.text="SPINNING...";const o=u-9;M.text=`Balance: ${o}`,ot(),g.text="",g.alpha=0;try{const s=await(await fetch("/api/slot_expanding_wilds/spin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({balance:u})})).json();if(s.error){u=s.balance,M.text=`Balance: ${u}`,u<1?R():tt();return}k.forEach(D=>D.startSpin());const{reels:E,win:N,winningLines:j,balance:G,scatters:O}=s,X=E.length===2;let I=null,m=null;X?(I=E[0],m=E[1]):m=E[0],k.forEach((D,A)=>{setTimeout(()=>{D.onStopComplete=async()=>{if(A===k.length-1){if(I){const v=[];for(let b=0;b<z;b++)m[b]?.includes(1)&&v.push(b);for(const b of v)await k[b].playExpandWild(I[b]),await new Promise(Y=>setTimeout(Y,80))}u=G,M.text=`Balance: ${u}`,N>0&&(g.text=`Win: ${N}`,g.alpha=1),j.forEach(({lineIndex:v,length:b})=>{lt(v);const Y=st[v];for(let W=0;W<b;W++){const ft=Y[W];at(W,ft)}}),Array.isArray(O)&&O.forEach(({col:v,row:b})=>rt(v,b)),u<1?R():tt(),S.text="SPIN",h.tint=16777215,h.eventMode="static"}},D.stopAt(m[A])},A*f.reelDelay+f.spinDuration+1)})}catch(c){console.error("Spin request failed:",c),S.text="SPIN",h.tint=16777215,h.eventMode="static"}});let $=!1;window.addEventListener("keydown",o=>{o.code==="Space"&&!$&&($=!0,o.preventDefault(),h.eventMode==="static"&&u>=1&&h.emit("pointerdown"))}),window.addEventListener("keyup",o=>{o.code==="Space"&&($=!1)})}mt();
