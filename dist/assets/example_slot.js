const{Application:J,Graphics:g,Text:G,Container:K,Sprite:L,Assets:Q,BlurFilter:U}=PIXI,l={spinDuration:150,reelDelay:100,startSpeed:35,decelFactor:.75,minSpeed:10,bounceAmplitude:150,bounceDuration:500,bounceEase:c=>1-(1-c)**2,enableBlur:!0,maxBlur:6,easeOut:c=>1-(1-c)**3};function H(c){return c>=1e3?`S10_${c%1e3}`:`S${c}`}class V{constructor(e,t,i,s,n,h,r){this.app=e,this.textures=t,this.x=i,this.y=s,this.visibleCount=n,this.cellSize=h,this.symbols=Array.from({length:20},()=>Math.floor(Math.random()*9)+1),this.offset=0,this.container=new K,this.container.mask=r,e.stage.addChild(this.container),this.sprites=Array.from({length:n},(p,a)=>{const f=new L(this.textures[`S${this.symbols[a]}`]);return f.width=h-10,f.height=h-10,f.x=this.x+5,f.y=this.y+(n-1-a)*h+5,this.container.addChild(f),f}),this.isSpinning=!1,this.speed=0,this.state="idle",this.stopSymbols=[],this.onStopComplete=null,this.filter=new U,this.filter&&(this.filter.strength=0,this.sprites.forEach(p=>p.filters=[this.filter])),this.shine=new g().rect(this.x+2,this.y,h-4,this.visibleCount*h).fill({color:16777215,alpha:0}),this.container.addChild(this.shine)}randomSymbol(){return Math.floor(Math.random()*9)+1}startSpin(){this.isSpinning=!0,this.state="spinning",this.speed=l.startSpeed,this.stopSymbols=[],this.filter&&(this.filter.strength=l.maxBlur)}stopAt(e){this.stopSymbols=e.slice(),this.state="stopping"}update(e){if(this.isSpinning){for(this.state==="stopping"&&this.speed>l.minSpeed&&(this.speed-=l.decelFactor),this.offset+=this.speed*(e/16.6);this.offset>=this.cellSize;)this.offset-=this.cellSize,this.symbols.pop(),this.symbols.unshift(this.randomSymbol());if(this.filter&&l.enableBlur){const t=Math.min(this.speed/l.startSpeed,1);this.filter.strength=l.maxBlur*t}for(let t=0;t<this.visibleCount;t++){const i=(t+Math.floor(this.offset/this.cellSize))%this.symbols.length,s=this.symbols[i],n=this.sprites[this.visibleCount-1-t];n.texture=this.textures[H(s)],n.y=this.y+(this.visibleCount-1-t)*this.cellSize+5+this.offset%this.cellSize}this.state==="stopping"&&this.speed<=l.minSpeed&&this.alignToStop()}}alignToStop(){this.speed=0,this.isSpinning=!1,this.state="idle";for(let e=0;e<this.visibleCount;e++){const t=this.stopSymbols[e]!==void 0?this.stopSymbols[e]:this.randomSymbol(),i=this.sprites[this.visibleCount-1-e];i.texture=this.textures[H(t)],i.y=this.y+(this.visibleCount-1-e)*this.cellSize+5}this._bounceDone=!1,this._shineDone=!1,this.filter&&(this.filter.strength=l.maxBlur*.3),this.startBounce(),this.shineSweep()}startBounce(){const e=l.bounceAmplitude,t=l.bounceDuration,i=l.bounceEase,s=performance.now(),n=()=>{const h=Math.min((performance.now()-s)/t,1),r=i(h),p=Math.sin(r*Math.PI)*e*(1-r);for(let a=0;a<this.visibleCount;a++){const f=this.sprites[this.visibleCount-1-a];f.y=this.y+(this.visibleCount-1-a)*this.cellSize+5+p}this.filter&&l.enableBlur&&(this.filter.strength=l.maxBlur*.3*(1-r)),h>=1&&(this.filter&&(this.filter.strength=0),this.app.ticker.remove(n),this._bounceDone=!0,this._shineDone&&this.onStopComplete&&this.onStopComplete(this))};this.app.ticker.add(n)}shineSweep(){const e=this.visibleCount*this.cellSize,t=300,i=performance.now(),s=()=>{const n=Math.min((performance.now()-i)/t,1),h=this.y+n*e,r=n<.5?.6:.6*(1-(n-.5)*2);this.shine.clear(),this.shine.rect(this.x+2,h,this.cellSize-4,this.cellSize/2),this.shine.fill({color:16777215,alpha:r}),n>=1&&(this.shine.clear(),this.app.ticker.remove(s),this._shineDone=!0,this._bounceDone&&this.onStopComplete&&this.onStopComplete(this))};this.app.ticker.add(s)}}async function Z(){const c=document.getElementById("exampleSlotCanvas"),e=4/3;let t=Math.min(window.innerWidth,980),i=t/e;i>Math.min(window.innerHeight,735)&&(i=Math.min(window.innerHeight,735),t=i*e);const s=new J;await s.init({canvas:c,background:"#333333",width:t,height:i});const n=t*.1,h=i*.2,r=t*.8,p=i*.6,a=h,f=new g().roundRect(n,a,r,p,16).fill({color:2236962}).stroke({width:3,color:16777215});s.stage.addChild(f);const C=5,_=3,x=Math.min(r/C,p/_),M=C*x,D=_*x,v=n+(r-M)/2,B=a+(p-D)/2,I=10,m=x/2,z=I*m,A=v+(M-z)/2,N=B-m*1.2,j=new g().roundRect(A-8,N-8,z+16,m+16,8).fill({color:4473924}).stroke({width:2,color:16777215});s.stage.addChild(j);for(let o=0;o<I;o++){const S=new g().roundRect(A+o*m,N,m-4,m-4,6).fill({color:2236962}).stroke({width:2,color:8947848});s.stage.addChild(S)}Array(10).fill(null);const E=new g().rect(v,B,M,D).fill({color:16777215});s.stage.addChild(E);const F=["S1","S2","S3","S4","S5","S6","S7","S8","S9","S10","S10_1","S10_2","S10_3","S10_5","S10_8","S10_10","S10_12","S10_15","S10_20","S10_25","S10_50","S10_100"],P={};for(const o of F)P[o]=await Q.load(`/assets/example_slot/${o}.png`);const b=[];for(let o=0;o<C;o++){const S=v+o*x,k=new V(s,P,S,B,_,x,E);b.push(k)}s.ticker.add(o=>b.forEach(S=>S.update(o.deltaMS)));let y=100;const w=new G({text:`Balance: ${y}`,style:{fill:"#ffffff",fontSize:22,fontWeight:"bold"}});w.x=t-160,w.y=10,s.stage.addChild(w);const R=r*.4,W=50,O=t/2-R/2,X=a+p+i*.05,d=new g().roundRect(O,X,R,W,10).fill({color:43520}).stroke({width:3,color:16777215});s.stage.addChild(d);const u=new G({text:"SPIN",style:{fill:"#ffffff",fontSize:24,fontWeight:"bold"}});u.anchor.set(.5),u.x=t/2,u.y=X+W/2,s.stage.addChild(u),d.eventMode="static",d.cursor="pointer",d.on("pointerdown",async()=>{d.eventMode="none",d.tint=34816,u.text="SPINNING...",b.forEach(o=>o.startSpin());try{const o=await fetch("/api/example_slot/spin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({balance:y})}),{reels:S,collected:k,win:Y,balance:q}=await o.json();console.log(b),console.log(k),console.log(Y),console.log(y),b.forEach(($,T)=>{setTimeout(()=>{$.onStopComplete=tt=>{T===b.length-1&&(y=q,w.text=`Balance: ${y}`,u.text="SPIN",d.tint=16777215,d.eventMode="static")},$.stopAt(S[T])},T*l.reelDelay+l.spinDuration)})}catch(o){console.error("Spin request failed:",o),u.text="SPIN",d.tint=16777215,d.eventMode="static"}})}Z();
