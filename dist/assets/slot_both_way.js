const{Application:at,Graphics:_,Text:Y,Container:it,Sprite:lt,Assets:ht,BlurFilter:st}=PIXI,h={spinDuration:150,reelDelay:100,startSpeed:35,decelFactor:.75,minSpeed:10,bounceAmplitude:150,bounceDuration:500,bounceEase:f=>1-(1-f)**2,enableBlur:!0,maxBlur:6,easeOut:f=>1-(1-f)**3};function N(f){if(f===1)return"symbol_1";if(f===2)return"symbol_2";if(f===3)return"symbol_3";if(f===4)return"symbol_4";if(f===5)return"symbol_5";if(f===6)return"symbol_6";if(f===7)return"symbol_7";if(f===8)return"symbol_8"}const G=[[0,0,0,0,0],[1,1,1,1,1],[2,2,2,2,2],[0,1,2,1,0],[2,1,0,1,2]];class ft{constructor(s,t,e,i,a,c,p){this.app=s,this.textures=t,this.x=e,this.y=i,this.visibleCount=a,this.cellSize=c,this.symbols=Array.from({length:20},()=>Math.floor(Math.random()*7)+2),this.offset=0,this.container=new it,this.container.mask=p,s.stage.addChild(this.container),this.sprites=Array.from({length:a},(w,y)=>{const b=new lt(this.textures[N(this.symbols[y])]);return b.width=c-10,b.height=c-10,b.x=this.x+5,b.y=this.y+y*c+5,this.container.addChild(b),b}),this.isSpinning=!1,this.speed=0,this.state="idle",this.stopSymbols=[],this.onStopComplete=null,this.filter=new st,this.filter&&(this.filter.strength=0,this.sprites.forEach(w=>w.filters=[this.filter])),this.shine=new _().rect(this.x+2,this.y,c-4,this.visibleCount*c).fill({color:16777215,alpha:0}),this.container.addChild(this.shine)}randomSymbol(){return Math.floor(Math.random()*7)+2}startSpin(){this.isSpinning=!0,this.state="spinning",this.speed=h.startSpeed,this.stopSymbols=[],this.filter&&(this.filter.strength=h.maxBlur)}stopAt(s){this.stopSymbols=s.slice(),this.state="stopping"}update(s){if(this.isSpinning){for(this.state==="stopping"&&this.speed>h.minSpeed&&(this.speed-=h.decelFactor),this.offset+=this.speed*(s/16.6);this.offset>=this.cellSize;)this.offset-=this.cellSize,this.symbols.pop(),this.symbols.unshift(this.randomSymbol());if(this.filter&&h.enableBlur){const t=Math.min(this.speed/h.startSpeed,1);this.filter.strength=h.maxBlur*t}for(let t=0;t<this.visibleCount;t++){const e=(t+Math.floor(this.offset/this.cellSize))%this.symbols.length,i=this.symbols[e],a=this.sprites[t];a.texture=this.textures[N(i)],a.y=this.y+t*this.cellSize+5+this.offset%this.cellSize}this.state==="stopping"&&this.speed<=h.minSpeed&&this.alignToStop()}}alignToStop(){this.speed=0,this.isSpinning=!1,this.state="idle";for(let s=0;s<this.visibleCount;s++){const t=this.stopSymbols[s]!==void 0?this.stopSymbols[s]:this.randomSymbol(),e=this.sprites[s];e.texture=this.textures[N(t)],e.y=this.y+s*this.cellSize+5}this._bounceDone=!1,this._shineDone=!1,this.filter&&(this.filter.strength=h.maxBlur*.3),this.startBounce(),this.shineSweep()}startBounce(){const s=h.bounceAmplitude,t=h.bounceDuration,e=h.bounceEase,i=performance.now(),a=()=>{const c=Math.min((performance.now()-i)/t,1),p=e(c),w=Math.sin(p*Math.PI)*s*(1-p);for(let y=0;y<this.visibleCount;y++){const b=this.sprites[y];b.y=this.y+y*this.cellSize+5+w}this.filter&&h.enableBlur&&(this.filter.strength=h.maxBlur*.3*(1-p)),c>=1&&(this.filter&&(this.filter.strength=0),this.app.ticker.remove(a),this._bounceDone=!0,this._shineDone&&this.onStopComplete&&this.onStopComplete(this))};this.app.ticker.add(a)}shineSweep(){const s=this.visibleCount*this.cellSize,t=300,e=performance.now(),i=()=>{const a=Math.min((performance.now()-e)/t,1),c=this.y+a*s,p=a<.5?.6:.6*(1-(a-.5)*2);this.shine.clear(),this.shine.rect(this.x+2,c,this.cellSize-4,this.cellSize/2),this.shine.fill({color:16777215,alpha:p}),a>=1&&(this.shine.clear(),this.app.ticker.remove(i),this._shineDone=!0,this._bounceDone&&this.onStopComplete&&this.onStopComplete(this))};this.app.ticker.add(i)}setInstant(s){for(let t=0;t<this.visibleCount;t++){const e=s[t]??this.randomSymbol(),i=this.sprites[t];i.texture=this.textures[N(e)],i.y=this.y+t*this.cellSize+5}}playExpandWild(s){return new Promise(t=>{const e=new _().roundRect(this.x+4,this.y+4,this.cellSize-8,this.visibleCount*this.cellSize-8,10).fill({color:16737792,alpha:0});this.filter&&(e.filters=[new st(4)]),this.container.addChild(e),gsap.to(e,{alpha:.75,duration:.18,yoyo:!0,repeat:1,ease:"sine.inOut",onRepeat:()=>{this.setInstant(s)},onComplete:()=>{this.container.removeChild(e),e.destroy(),t()}})})}}async function ct(){const f=document.getElementById("slotBothWayCanvas"),s=4/3;let t=Math.min(window.innerWidth,980),e=t/s;e>Math.min(window.innerHeight,735)&&(e=Math.min(window.innerHeight,735),t=e*s);const i=new at;await i.init({canvas:f,background:"#333333",width:t,height:e});const a=t*.1,c=e*.15,p=t*.8,w=e*.6,y=c,b=new _().roundRect(a,y,p,w,16).fill({color:2236962}).stroke({width:3,color:16777215});i.stage.addChild(b);const z=5,W=3,r=Math.min(p/z,w/W),H=z*r,F=W*r,B=a+(p-H)/2,k=y+(w-F)/2,q=new _().rect(B,k,H,F).fill({color:16777215});i.stage.addChild(q);const nt=["symbol_1","symbol_2","symbol_3","symbol_4","symbol_5","symbol_6","symbol_7","symbol_8"],J={};for(const n of nt)J[n]=await ht.load(`/assets/slot_both_way/${n}.png`);const T=[];for(let n=0;n<z;n++){const m=B+n*r,o=new ft(i,J,m,k,W,r,q);T.push(o)}i.ticker.add(n=>T.forEach(m=>m.update(n.deltaMS)));const E=new it;i.stage.addChild(E);function ot(){E.children.forEach(n=>{gsap.killTweensOf(n.scale)}),E.removeChildren()}const K=[16726843,3931963,3894527,16767291,16727029];function Q(n){const m=G[n];if(!m)return;const o=new _,P=K[n%K.length],L=Math.max(4,r*.08),R=B+r/2,$=k+m[0]*r+r/2;o.moveTo(R,$);for(let d=1;d<z;d++){const D=B+d*r+r/2,I=k+m[d]*r+r/2;o.lineTo(D,I)}o.stroke({width:L,color:P,alpha:.9,cap:"round",join:"round"}),o.alpha=0,E.addChild(o);const j=250,M=performance.now(),v=()=>{const d=Math.min((performance.now()-M)/j,1);o.alpha=d,d<1&&i.ticker.addOnce(v)};return i.ticker.addOnce(v),o}function U(n,m){const o=new _().circle(0,0,r*.45).fill({color:16777113,alpha:.35});o.x=B+n*r+r/2,o.y=k+m*r+r/2,E.addChild(o),gsap.fromTo(o.scale,{x:1,y:1},{x:1.2,y:1.2,duration:.6,yoyo:!0,repeat:-1,ease:"sine.inOut"})}let u=1e3;const C=new Y({text:`Balance: ${u}`,style:{fill:"#ffffff",fontSize:Math.min(e*.03,20),fontWeight:"bold"}});C.x=t-180,C.y=10,C.text=`Balance: ${u}`,i.stage.addChild(C);const g=new Y({text:"",style:{fill:"#ffffff",fontSize:Math.min(e*.03,20),fontWeight:"bold"}});g.x=t/2,g.y=10,g.alpha=0,i.stage.addChild(g);const V=p*.4,Z=50,rt=t/2-V/2,tt=y+w+e*.05,l=new _().roundRect(rt,tt,V,Z,10).fill({color:43520}).stroke({width:3,color:16777215});i.stage.addChild(l);const x=new Y({text:"SPIN",style:{fill:"#ffffff",fontSize:24,fontWeight:"bold"}});x.anchor.set(.5),x.x=t/2,x.y=tt+Z/2,i.stage.addChild(x);function A(){l.eventMode="none",l.tint=5592405,x.text="NO BALANCE"}function et(){l.eventMode="static",l.tint=43520,x.text="SPIN"}l.eventMode="static",l.cursor="pointer",l.on("pointerdown",async()=>{if(u<1){A();return}l.eventMode="none",l.tint=34816,x.text="SPINNING...";const n=u-1;C.text=`Balance: ${n}`,ot(),g.text="",g.alpha=0;try{const o=await(await fetch("/api/slot_both_way/spin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({balance:u})})).json();if(o.error){u=o.balance,C.text=`Balance: ${u}`,u<1?A():et();return}T.forEach(M=>M.startSpin());const{reels:P,win:L,winningLinesLeft:R,winningLinesRight:$,balance:j}=o;T.forEach((M,v)=>{setTimeout(()=>{M.onStopComplete=async()=>{v===T.length-1&&(u=j,C.text=`Balance: ${u}`,L>0&&(g.text=`Win: ${L}`,g.alpha=1),R.forEach(({lineIndex:d,length:D})=>{Q(d);const I=G[d];for(let S=0;S<D;S++){const X=I[S];U(S,X)}}),$.forEach(({lineIndex:d,length:D})=>{Q(d);const I=G[d];for(let S=0;S<D;S++){const X=I[S];U(4-S,X)}}),u<1?A():et(),x.text="SPIN",l.tint=16777215,l.eventMode="static")},M.stopAt(P[v])},v*h.reelDelay+h.spinDuration+1)})}catch(m){console.error("Spin request failed:",m),x.text="SPIN",l.tint=16777215,l.eventMode="static"}});let O=!1;window.addEventListener("keydown",n=>{n.code==="Space"&&!O&&(O=!0,n.preventDefault(),l.eventMode==="static"&&u>=1&&l.emit("pointerdown"))}),window.addEventListener("keyup",n=>{n.code==="Space"&&(O=!1)})}ct();
